<script>
  const peer = new Peer(); // public server
  let localStream;

  // 1) grab a tiny audio stream so we can call
  navigator.mediaDevices.getUserMedia({ audio: true, video: false })
    .then(stream => {
      localStream = stream;
      console.log('[Viewer] Local audio stream ready:', stream);
    })
    .catch(err => {
      console.error('[Viewer] getUserMedia error:', err);
    });

  document.getElementById('connect-btn').onclick = () => {
    const remoteId = document.getElementById('peer-id-input').value.trim();
    console.log('[Viewer] Attempting to call:', remoteId);
    if (!remoteId) return alert('Please enter a Peer ID');
    if (!localStream) return alert('Microphone stream not ready.');

    const call = peer.call(remoteId, localStream);
    if (!call) {
      console.error('[Viewer] peer.call() returned:', call);
      return alert('Call initiation failed.');
    }

    call.on('stream', remoteStream => {
      console.log('[Viewer] Received remote stream:', remoteStream);
      const videoEl = document.getElementById('vid');
      videoEl.srcObject = remoteStream;
      console.log('[Viewer] Assigned srcObject, calling play()');
      videoEl.onloadedmetadata = () => {
        videoEl.play()
          .then(() => console.log('[Viewer] Playback started'))
          .catch(e => console.warn('[Viewer] play() failed:', e));
      };
      // Also log tracks
      remoteStream.getTracks().forEach(t => console.log('[Viewer] track:', t.kind, t));
    });

    call.on('error', err => {
      console.error('[Viewer] call error:', err);
      alert('Connection error: ' + err);
    });

    call.on('close', () => {
      console.log('[Viewer] call closed');
    });
  };
</script>
